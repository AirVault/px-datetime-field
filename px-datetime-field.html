
<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../polymer/polymer.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-entry.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-behavior.html"/>
<link rel="import" href="../px-datetime-common/validate.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-buttons.html"/>
<link rel="import" href="../px-datetime-common/px-datetime-button-behavior.html"/>


<!--
The datetime components rely on <a href="https://momentjs.com/" target="_blank">Moment.js</a> and <a href="https://momentjs.com/timezone/" target="_blank">Moment Timezone</a>.

#### Usage

    <px-datetime-field></px-datetime-field>

#### Styling
The following custom property is available for styling. Please also refer to px-forms-design for additional variables that can be used to customize the field's appearance.

Custom property | Description | Default
----------------|-------------|----------
`--px-datetime-border-color-validation--failed` | Outline color for the field when validation fails | `$alert-red`

@element px-datetime-field
@blurb Element providing solution to no problem in particular.
@homepage index.html
@demo demo.html
-->

<link rel="import" href="css/px-datetime-field-styles.html">

<dom-module id="px-datetime-field">
  <template>
    <style include="px-datetime-field-styles"></style>

    <div class$="{{_getWrapClass(buttonWrap)}} inline--flex">
      <div class$="{{_getButtonMarginClass(showButtons)}} u-mb--">
        <div id="fieldWrapper" class$="{{_getWrapperClass(dateIsValid, timeIsValid, _forcedFailedClass, isSelected, _dropdownActive, _dropdownHoverFix)}}">
          <template is="dom-if" if="[[!hideDate]]">
            <px-datetime-entry
              id="date"
              class$="{{_getEntryDateClass(hideDate, hideTime)}}"
              date-or-time="Date"
              moment-format="{{dateFormat}}"
              moment-obj="{{momentObj}}"
              is-valid="{{dateIsValid}}"
              is-selected="{{isSelected}}"
              hide-icon="{{hideIcon}}"
              time-zone="{{timeZone}}"
              show-time-zone="{{_showTimeZoneInDate(hideTime, showTimeZone)}}"
              block-future-dates="{{blockFutureDates}}"
              block-past-dates="{{blockPastDates}}"
              resources="[[resources]]"
              language="[[language]]"
              formats="[[formats]]">
            </px-datetime-entry>
          </template>
          <template is="dom-if" if="[[!hideTime]]">
            <px-datetime-entry
              id="time"
              class="inline--flex"
              date-or-time="Time"
              moment-format="{{timeFormat}}"
              show-time-zone="{{showTimeZone}}"
              moment-obj="{{momentObj}}"
              is-valid="{{timeIsValid}}"
              hide-icon="{{hideIcon}}"
              time-zone="{{timeZone}}"
              is-selected="{{isSelected}}"
              block-future-dates="{{blockFutureDates}}"
              block-past-dates="{{blockPastDates}}"
              resources="[[resources]]"
              language="[[language]]"
              formats="[[formats]]">
            </px-datetime-entry>
          </template>
        </div>
        <template is="dom-if" if="{{!isValid}}">
          <div class="form-field__help validation-error dt-validation-text">{{_validationErrorMessage}}</div>
        </template>
      </div>
      <template is="dom-if" if="{{showButtons}}">
        <px-datetime-buttons
          is-submit-button-valid="[[isValid]]"
          resources="[[resources]]"
          language="[[language]]"
          formats="[[formats]]">
        </px-datetime-buttons>
      </template>
    </div>
  </template>
</dom-module>

<script>
  Polymer({
    is: 'px-datetime-field',

    behaviors: [
      pxDatetimeBehavior,
      pxDatetimeButtonBehavior,
      validate
    ],

    properties: {
      /**
       * Moment format string for the DATE format to display/validate this field against
       * Year, month, day and offset tokens (Do not support Y, Q, MMM, MMMM, or Do)
       * (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       */
      dateFormat: {
          type: String,
          value: 'YYYY-MM-DD'
      },
      /**
       * Moment format string for the TIME format to display/validate this field against
       * Hour, minute, second, millisecond, and offset tokens
       * (see http://momentjs.com/docs/#/parsing/string-format/)
       *
       */
      timeFormat: {
          type: String,
          value: 'HH:mm:ss'
      },
      /**
       *
       * Can be set to show the timezone. Can have 2 values:
       *  'dropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone. Only contains a subset of all timezones
       *  'extendedDropdown': shows the time zone as a dropdown which the user can use to
       * select a different time zone. Contains all existing timezones (588)
       *  'text': shows the time zone as text, non editable
       *  'abbreviatedText': shows the time zone as an abbreviated text, non editable (such as PST, EST...)
       */
      showTimeZone: {
        type: String,
        value: ''
      },
      /**
       * Controls whether time is displayed in this field
       */
      hideTime: {
        type: Boolean,
        value: false
      },
      /**
       * Controls whether date should be hidden in this field. Typically used
       * in combination with hideTime to make the field showing only the time
       */
      hideDate: {
        type: Boolean,
        value: false
      },
      /**
       * Controls whether the calendar/clock icon should be hidden
       */
      hideIcon: {
        type: Boolean,
        value: false
      },
      /**
       * Controls whether the buttons will wrap under the field if the horizontal
       * space is too small.
       */
      buttonWrap: {
        type: Boolean,
        value: false
      },
      /**
       * Reflects if the date shown is valid.
       * @private
       */
      dateIsValid: {
        type: Boolean,
        value: true,
        notify: true
      },
      /**
       * Reflects if the time shown is valid.
       * @private
       */
      timeIsValid: {
        type: Boolean,
        value: true,
        notify: true
      },
      /**
       * If showing only the date whether the date is valid,
       * if showing only thetime whether the time is valid,
       * if showing both whether both are valids
       */
      isValid: {
        type: Boolean,
        notify: true,
        computed: '_getIsValid(dateIsValid, timeIsValid)'
      },
      /**
       * Used to display the error message when an entry in not valid
       */
      _validationErrorMessage: {
        type: String,
        value: ''
      },
      /**
       * Used to determine if the 'validation-failed' class need to be applied to '_getWrapperClass'
       * this attribute is set by px-datetime-rage-field
       * @private
       */
      _forcedFailedClass: {
        type: Boolean,
        value: false
      },
      /**
       * True if any cell is currently selected.
       * @private
       */
      isSelected: {
        type: Boolean,
        notify: true
      },

      /**
       * Used to prevent this element from firing px-datetime-range-submitted
       * event and prevent changes to range
       */
      preventNotificationOnChange: {
        type: Boolean,
        value: false
      },
      /**
       * used to set the correct classes when the dropdown is open.
       */
      _dropdownOpened: {
        type: Boolean,
        value: false
      },
      /**
       * Used to toggle the `dt-dropdown-is-active` class
       */
      _dropdownActive: {
        type: Boolean,
        value: false
      },
      /**
       * Used to toggle the `dt-dropdown-is-active` class
       */
      _dropdownHoverFix: {
        type: Boolean,
        value: false
      }
    },
    /*
     *
     */
    listeners: {
      'px-datetime-entry-icon-clicked':'_iconClicked',
      'px-next-field': '_nextFieldRequired',
      'px-previous-field': '_previousFieldRequired',
      'px-datetime-button-clicked': '_dateTimeButtons',
      'px-validation-message' : '_handleValidationMessage',
      'opened-changed' : '_handleDropdownOpened',
      'px-dropdown-focused': '_handleDropdownFocus',
      'px-dropdown-blured': '_handleDropdownBlur'
    },

    /*
     *
     */
    _showTimeZoneInDate: function(hideTime, showTimeZone) {
      if(hideTime || hideTime === true) {
        return showTimeZone;
      }else {
        return ''
      }
    },
    observers: ['_momentChanged(momentObj)'],
    /**
     * Key bindings for iron-a11y-keys-behavior
     */
    keyBindings: {
      'esc' : '_onEsc',
      'enter': '_onEnter'
    },
    /*
     *
     */
    _nextFieldRequired: function(evt) {
      var date = this.$$('#date');

      //if this comes from date do some logic, otherwise let it propagate
      if(date && evt.detail.dateOrTime === 'Date') {
        if(!this.hideTime) {
          this.$$('#time')._focusCell(0);
          evt.stopPropagation();
          evt.stopImmediatePropagation();
        }
      }
    },
    /*
     *
     */
    _previousFieldRequired: function(evt) {
      var time = this.$$('#time');

      //if this comes from time do some logic, otherwise let it propagate
      if(time && evt.detail.dateOrTime === 'Time') {
        if(!this.hideDate) {
          this.$$('#date')._focusLastCell();
          evt.stopPropagation();
          evt.stopImmediatePropagation();
        }
      }
    },
    /*
     *
     */
    _focusFirstEntry: function(forceTimeFocus) {
      if(!this.hideDate && !forceTimeFocus) {
        this.$$('#date')._focusCell(0);
      } else {
        this.$$('#time')._focusCell(0);
      }
    },
    /*
     *
     */
    _focusLastEntry: function() {
      if(!this.hideTime) {
        this.$$('#time')._focusLastCell();
      } else {
        this.$$('#date')._focusLastCell();
      }
    },
    /**
     */
    _getWrapClass: function(buttonWrap){
      if(buttonWrap){
        return "flex--wrap"
      }
    },
    /**
     */
    _getButtonMarginClass: function(showButtons) {
      if(showButtons){
        return "u-mr-";
      }
    },
    /**
     * event that watches when the dropdown has focus
     * to
     */
    _handleDropdownFocus: function(e){
      e.stopPropagation();
      this.set('_dropdownActive', true);
      console.log("focus")
    },
    /**
     * event that watches when the dropdown has focus
     */
    _handleDropdownBlur: function(e){
      e.stopPropagation();
      this.set('_dropdownActive', false);

      this._handleHoverFix();
    },
    detached: function(){
      this._dropdownFocused = false;
    },
    /**
     * Inorder to make dt-field look like an input field we have
     * to force some css.
     *
     */
    _handleHoverFix(){
      this.set('_dropdownHoverFix', true);
      this.async(function(){
        this.set('_dropdownHoverFix', false);
      },1000);
    },
    /**
     * dateIsValid, timeIsValid, & _forcedFailedClass - determine weither to show the validation error classes
     * isSelected - sets the styles when an entryCell is selected
     * _d
     *
     */
    _getWrapperClass: function(dateIsValid, timeIsValid, _forcedFailedClass, isSelected, _dropdownActive, _dropdownHoverFix) {
      var classList = "inline--flex dt-text-field ";

      if(dateIsValid !== true || timeIsValid !== true || _forcedFailedClass === true) {
        classList += "validation-error validation-failed ";
      } else if(isSelected) {
        classList += "dt-is-selected ";
      } else if(_dropdownActive){
        classList += "dt-dropdown-is-active ";
      } else if (_dropdownHoverFix){
        classList += "dt-text-field--hover-fix ";
      }
      return classList;
    },
    /**
     */
    _getEntryDateClass: function(hideDate, hideTime) {
      var classList = "inline--flex ";

      if(hideDate === false && hideTime === false) {
        classList += "u-mr- ";
      }

      return classList;
    },
    /*
     *
     */
    _getIsValid: function(dateIsValid, timeIsValid) {
      return dateIsValid && timeIsValid;
    },
    /*
     * Listen for the validation message to change and reflect the changes to _validationErrorMessage
     */
    _handleValidationMessage: function(e){
      this.set('_validationErrorMessage', e.detail.validationErrorMessage)
    },
    _handleDropdownOpened: function(e){
      this.set('_dropdownActive', e.detail.value);
    },
    /*
     *
     */
    _iconClicked: function(evt) {
      if(evt.detail.dateOrTime === "Date") {
        this.$$('#date')._focusCell(0);
      } else {
        this.$$('#time')._focusCell(0);
      }
    },
    _momentChanged: function(momentObj) {
      if(this.isValid === true && !this.showButtons && !this.preventNotificationOnChange) {

        this._applyCurrentValues(true);
      }
    },
    _dateTimeButtons: function(evt) {
      if(!this.preventNotificationOnChange) {
        this._applyCurrentValues(evt.detail.action);
      }
    },
    _onEsc: function(evt) {
      if(this.showButtons && !this.preventNotificationOnChange) {
        this._applyCurrentValues(false);
      }
    },
    _onEnter: function(evt) {
      if(this.showButtons && !this.preventNotificationOnChange) {
        this._applyCurrentValues(true);
      }
    },
  });
</script>
